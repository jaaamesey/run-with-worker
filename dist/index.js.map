{"version":3,"sources":["../src/index.ts"],"sourcesContent":["const WORKER_URL = URL.createObjectURL(\n  new Blob([\n    \"onmessage = (m) => (async function(){}).constructor(m.data.funcStr)(m.data.args)\",\n  ]),\n);\n\nexport async function runWithWorker<T, D extends Readonly<[...any]>>(\n  func: (\n    ...deps: {\n      [i in keyof D]: Awaited<D[i]> extends infer R extends Record<\n        string,\n        unknown\n      >\n        ? R extends { _$trustedScriptUrl: string }\n          ? Awaited<D[i]>\n          : { _$trustedScriptUrl: never } & {\n              [f in keyof R]: R[f] extends Function ? never : R[f];\n            }\n        : Awaited<D[i]>;\n    } & Array<any>\n  ) => T,\n  deps?: Readonly<[...D]>,\n  opts?: { workerOptions?: WorkerOptions },\n): Promise<T> {\n  const worker = new Worker(WORKER_URL, opts?.workerOptions);\n  return new Promise(async (resolve, reject) => {\n    try {\n      const awaitedDeps = await Promise.all(deps ?? []);\n      const args = awaitedDeps.map((d) => {\n        if (typeof d?._$trustedScriptUrl === \"string\") {\n          return {\n            $__trustedScript: `import(${JSON.stringify(d._$trustedScriptUrl)})`,\n          };\n        }\n        return d;\n      });\n      const funcStr = `Promise.all(arguments[0].map(d => d && typeof d.$__trustedScript === 'string' ? eval(d.$__trustedScript) : d)).then(deps => (${func.toString()})(...deps)).then(r=>postMessage(r)).catch(e=>postMessage({$__error:e}))`;\n      worker.onmessage = (m) => {\n        m.data?.$__error ? reject(m.data?.$__error) : resolve(m.data);\n        worker.terminate();\n      };\n      worker.onerror = (e) => {\n        reject(e);\n        worker.terminate();\n      };\n      worker.onmessageerror = (e) => {\n        reject(e);\n        worker.terminate();\n      };\n      worker.postMessage({ funcStr, args });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAAM,aAAa,IAAI;AAAA,EACrB,IAAI,KAAK;AAAA,IACP;AAAA,EACF,CAAC;AACH;AAEA,SAAsB,cACpB,MAcA,MACA,MACY;AAAA;AACZ,UAAM,SAAS,IAAI,OAAO,YAAY,6BAAM,aAAa;AACzD,WAAO,IAAI,QAAQ,CAAO,SAAS,WAAW;AAC5C,UAAI;AACF,cAAM,cAAc,MAAM,QAAQ,IAAI,sBAAQ,CAAC,CAAC;AAChD,cAAM,OAAO,YAAY,IAAI,CAAC,MAAM;AAClC,cAAI,QAAO,uBAAG,wBAAuB,UAAU;AAC7C,mBAAO;AAAA,cACL,kBAAkB,UAAU,KAAK,UAAU,EAAE,kBAAkB,CAAC;AAAA,YAClE;AAAA,UACF;AACA,iBAAO;AAAA,QACT,CAAC;AACD,cAAM,UAAU,gIAAgI,KAAK,SAAS,CAAC;AAC/J,eAAO,YAAY,CAAC,MAAM;AArChC;AAsCQ,mBAAE,SAAF,mBAAQ,YAAW,QAAO,OAAE,SAAF,mBAAQ,QAAQ,IAAI,QAAQ,EAAE,IAAI;AAC5D,iBAAO,UAAU;AAAA,QACnB;AACA,eAAO,UAAU,CAAC,MAAM;AACtB,iBAAO,CAAC;AACR,iBAAO,UAAU;AAAA,QACnB;AACA,eAAO,iBAAiB,CAAC,MAAM;AAC7B,iBAAO,CAAC;AACR,iBAAO,UAAU;AAAA,QACnB;AACA,eAAO,YAAY,EAAE,SAAS,KAAK,CAAC;AAAA,MACtC,SAAS,GAAG;AACV,eAAO,CAAC;AAAA,MACV;AAAA,IACF,EAAC;AAAA,EACH;AAAA;","names":[]}